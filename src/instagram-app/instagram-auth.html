<link rel="import" href="../../bower_components/x-user-dropdown/x-user-dropdown.html">

<dom-module id="instagram-auth">
  <template>
    <style>
      :host([authorized]) .login {
        display: none;
      }
      :host(:not([authorized])) x-user-dropdown {
        display: none;
      }
    </style>
    <a class="login"
       href$="https://api.instagram.com/oauth/authorize/?client_id=[[clientId]]&redirect_uri=[[_redirectUri]]&response_type=token&scope=public_content">
      Login
    </a>

    <x-user-dropdown on-x-action="_logout"
                     src="[[userInfoResp.data.profile_picture]]"
                     name="[[_getName(userInfoResp.data)]]"></x-user-dropdown>
    <byutv-jsonp id="userInfoAjax"
                 url="https://api.instagram.com/v1/users/self"
                 params$='{"access_token": "[[accessToken]]"}'
                 last-response="{{userInfoResp}}"
                 on-error="_onError">
    </byutv-jsonp>
  </template>
  <script>
    Polymer({
      is: 'instagram-auth',

      properties: {
        /**
         * Instagram API client ID
         */
        clientId: {
          type: String,
          value: 'fef7b1bb238c4043a0e648cad678d2fa'
        },

        /**
         * Instagram OAuth access token
         */
        accessToken: {
          type: String,
          value: () => localStorage.getItem('token'),
          notify: true,
          observer: '_accessTokenChanged'
        },

        /**
         * Redirect URI for post-login action
         */
        _redirectUri: {
          type: String,
          value: window.location.origin + '/auth'
        },

        /**
         * Current route location
         */
        route: {
          type: Object,
          observer: '_routeChanged'
        },

        /**
         * Whether the user is logged in and authorized
         */
        authorized: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true
        }
      },

      /**
       * Logs the user out
       * @param e
       * @returns {boolean}
       * @private
       */
      _logout: function(e) {
        this.accessToken = null;
        e.preventDefault();
        return false;
      },

      /**
       * Handles changes to the access token
       * @param accessToken
       * @private
       */
      _accessTokenChanged: function(accessToken) {
        if (accessToken) {
          this.$.userInfoAjax.generateRequest();
        }
        this.authorized = !!accessToken;
      },

      /**
       * Handles changes to the current location
       * @param route
       * @private
       */
      _routeChanged: function(route) {
        const authActive = route.path === '/auth';
        if (authActive && /access_token/.test(window.location.hash)) {
          // hard-code temp token to escape sandboxed mode (token will be manually reset later)
          this.accessToken = '2954200289.e029fea.8a4325bdda50453f835b31ce5e77b278'; // window.location.hash.split('=')[1];
          localStorage.setItem('token', this.accessToken);

          // reset to origin to remove token from address bar
          history.replaceState({}, document.title, '/');
        } else if (authActive) {
          console.warn('no access token');
        }
      },

      /**
       * Handles JSONP errors
       * @private
       */
      _onError: function() {
        console.warn('JSONP error', arguments);
      },

      /**
       * Gets the user's display name
       * @param userInfo
       * @returns the user's name
       * @private
       */
      _getName: function(userInfo) {
        return userInfo.full_name || userInfo.username;
      }
    });
  </script>
</dom-module>